<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqls>
<sqls>

	<sql id="selectearnings">
		SELECT 
			"日付時間" as status,
			"決済番号" as settlementno
		FROM "INPUT_売上詳細情報"
		WHERE 
			"日付時間" = :col0
			and "決済番号" = :col1
			and "トランザクションの種類" = :col2
			and "注文番号" = :col3
			and "SKU" = :col4
			and "合計" = :col27
			and "FLG" is null
	</sql>

	<sql id="deleteearnings">
		DELETE 
		FROM "INPUT_売上詳細情報"
		WHERE 
			"日付時間" = :col0
			and "決済番号" = :col1
			and "トランザクションの種類" = :col2
			and "注文番号" = :col3
			and "SKU" = :col4
			and "合計" = :col27
			and "FLG" is null
	</sql>

	<sql id="insertearnings">
		INSERT INTO "INPUT_売上詳細情報"
		(
			  "日付時間"
			, "決済番号"
			, "トランザクションの種類"
			, "注文番号"
			, "SKU"
			, "説明"
			, "数量"
			, "Amazon出品サービス"
			, "フルフィルメント"
			, "市町村"
			, "都道府県"
			, "郵便番号"
			, "税金徴収型"
			, "商品売上"
			, "商品の売上税"
			, "配送料"
			, "配送料の税金"
			, "ギフト包装手数料"
			, "ギフト包装クレジットの税金"
			, "Amazonポイントの費用"
			, "プロモーション割引額"
			, "プロモーション割引の税金"
			, "源泉徴収税を伴うマーケットプレイス"
			, "手数料"
			, "FBA 手数料"
			, "トランザクションに関するその他の手数料"
			, "その他"
			, "合計"
			, "FLG"
		)
		VALUES (
			:col0,
			:col1,
			:col2,
			:col3,
			:col4,
			:col5,
			:col6,
			:col7,
			:col8,
			:col9,
			:col10,
			:col11,
			:col12,
			:col13,
			:col14,
			:col15,
			:col16,
			:col17,
			:col18,
			:col19,
			:col20,
			:col21,
			:col22,
			:col23,
			:col24,
			:col25,
			:col26,
			:col27,
			'1'
		)
	</sql>

	<sql id="updateearnings">
		UPDATE "INPUT_売上詳細情報"
		SET "FLG" = null 
		WHERE "FLG" = '1'
	</sql>

	<sql id="searchearningslist">
		select
			"年月" as yearmonth
			, "注文数量" as ordercount
			, "注文粗利益" as orderprofit
			, "月額登録料" as monthlyfee
			, "広告費用" as adfee
			, "返品損失金額" as ruturnfee
			, "FBA入庫料金" as fbashipfee
			, "FBA保管料金" as fbastockfee
			, "振込金額" as remittance
			, "仕入費用" as purchase
			, "その他" as others
			, 0 - "振込金額" + "仕入費用" + "その他" as profit
		from
			( 
				select
					substr("仕入確定日", 1, 4) || '年' || substr("仕入確定日", 6, 2) || '月' as "年月"
					, 0 as "注文数量"
					, 0 as "注文粗利益"
					, 0 as "月額登録料"
					, 0 as "広告費用"
					, 0 as "返品損失金額"
					, 0 as "FBA入庫料金"
					, 0 as "FBA保管料金"
					, 0 as "振込金額"
					, case 
						when sum(cast("合計仕入費用円貨" as float)) is not null 
							then 0 - sum(cast("合計仕入費用円貨" as float)) 
						else 0 
						end as 仕入費用
					, 0 as "その他" 
				from
					"仕入管理" 
				group by
					"年月" 
				union all 
				select
					"年月"
					, sum( 
						case 
							when "トランザクションの種類" = '注文' 
								then "注文数量" 
							else 0 
							end
					) as "注文数量"
					, sum( 
						case 
							when "トランザクションの種類" = '注文' 
								then "合計" 
							else 0 
							end
					) as "注文粗利益"
					, sum( 
						case 
							when "トランザクションの種類" = '注文外料金' 
							and "説明" = '月額登録料' 
								then "合計" 
							else 0 
							end
					) as "月額登録料"
					, sum( 
						case 
							when "トランザクションの種類" = '注文外料金' 
							and "説明" = '広告費用' 
								then "合計" 
							else 0 
							end
					) as "広告費用"
					, sum( 
						case 
							when "トランザクションの種類" <> '注文' 
							and "説明" = '注文' 
								then "合計" 
							else 0 
							end
					) as "返品損失金額"
					, sum( 
						case 
							when "トランザクションの種類" = 'FBA 在庫関連の手数料' 
							and substr("説明",1,16 ) = 'FBAパートナーキャリアの配送料' 
								then "合計" 
							else 0 
							end
					) as "FBA入庫料金"
					, sum( 
						case 
							when "トランザクションの種類" = 'FBA 在庫関連の手数料' 
							and ( 
								substr("説明",1,8 ) = 'FBA保管手数料' 
								or "説明" = 'FBA長期在庫保管手数料' 
								or "説明" = 'FBA在庫の廃棄手数料'
							) 
								then "合計" 
							else 0 
							end
					) as "FBA保管料金"
					, sum( 
						case 
							when "トランザクションの種類" = '振込み' 
								then "合計" 
							else 0 
							end
					) as "振込金額"
					, 0 as "仕入金額"
					, 0 as "その他" 
				from
					( 
						select
							"年月"
							, "トランザクションの種類"
							, "説明"
							, sum("注文数量") as "注文数量"
							, sum("合計") as "合計" 
						FROM
							( 
								select
									substr("日付時間", 1, 4) || '年' || substr("日付時間", 6, 2) || '月' as "年月"
									, "日付時間"
									, "トランザクションの種類"
									, "注文番号"
									, "SKU"
									, case 
										when length(trim("注文番号")) > 10 
											then '注文' 
										else "説明" 
										end as "説明"
									, cast("数量" as float) as "注文数量"
									, cast("合計" as float) as "合計" 
								from
									"INPUT_売上詳細情報"
							) TEMP1 
						group by
							"年月"
							, "トランザクションの種類"
							, "説明"
					) TEMP2 
				group by
					"年月"
			) DATA 
		order by
			"年月" desc

	</sql>


</sqls>
